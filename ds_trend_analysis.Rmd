---
title: "Statistical analysis"
author: "Lukman Adeboye Soboyejo"
date: "2023-10-24"
output: word_document
always_allow_html: true
---

```{r global_options, include = TRUE}

knitr::opts_chunk$set(warning = TRUE, message = TRUE) 
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(echo= TRUE)

```

# --- maps and hypotheses

-   We hypothesized that:
-   channel capacity increases with catchment urbanisation, with detectable increases at major stormwater outfalls
-   woody debris (\>50mm) decrease with urban intensity, that is, downstream urban gradient
-   longitudinal pool-riffle spacing get longer and deeper with downstream urban gradient

```{r }

knitr::include_graphics('Z:/wergStaff/Lukman_Soboyejo/r_codes/private_git_stream_data/lucas_WERG/study_maps/img_1.jpg')

```

# --- data manipulation and themes

## (i) retrieving saved data from github and read channel data into R

-   **all_data** means all transects measurement
-   **ds_change** means change in impervious cover and channel form dimension or in-channel features change
-   **in_channel-data** means all in channel features observations

```{r }

# remove all object in r environment
# rm(list=ls(all=TRUE))

# get the URL by clicking on the raw data button to display the data in csv format
( all_data = read.csv("https://raw.githubusercontent.com/lukeng200/lucas_WERG/main/data/xs_3D.csv",
                  header = T,sep = ",") )
( ds_change = read.csv("https://raw.githubusercontent.com/lukeng200/lucas_WERG/main/data/ds_in_form.csv",
                  header = T,sep = ",") )
( in_channel_data = read.csv("https://raw.githubusercontent.com/lukeng200/lucas_WERG/main/data/xs_longitudinal.csv",
                  header = T,sep = ",") )

# view the data in a nice format with pander or kable
# knitr::kable(all_data)
# pander::pander( head( all_data ) )

```

## (ii) fonts and packages

```{r}

require( cowplot ) # data visualisation 
require(dplyr) # data manipulation
require(ggplot2) # data visualisation
require( ggrepel ) # showing data points text 
library( tidyverse ) # data visualisation and manipulation (dplyr + ggplot2)

# more?
library(data.table)
library(stringr)
library(ggplot2)
library(ggtext)
library(extrafont)


font_add_google("Jost","jo")
showtext_auto()

my_font = "jo"

```

## (iii) theme for visualisation

```{r}
theme_clean <- function(){
              theme_bw()+
              theme(
              axis.ticks.y = element_line( ),
              axis.text.y = element_text( ),
              axis.title.y = element_text( ),
              axis.line.y = element_line( ),
              axis.ticks.x = element_line( ),
              axis.text.x = element_text( ),
              axis.title.x = element_text( ),
              axis.line.x = element_line( ),
              legend.position = "bottom",
              legend.title = element_blank( ) )
}

theme_extra <- function(){
              theme_minimal( base_family = my_font ) +
              theme(  panel.grid.major = element_line(linetype = "dashed", 
                                                      linewidth = .35, color = "grey85"),
                      panel.grid.minor = element_line(linetype = "dashed", 
                                                      linewidth = .3, color = "grey85"),
                      plot.title    = element_text(face = "bold", size = 16, 
                                                   margin = margin(b = 5), family = my_font ),
                      plot.subtitle = element_markdown(margin = margin(b = 25), size = 11, 
                                                       color = "grey20", family = my_font ),
                      plot.caption  = element_markdown(margin = margin(t = 25), size = 8, 
                                                       family = my_font ),
                      plot.title.position = "plot",
                      plot.caption.position = "plot",
                      plot.background = element_rect(fill = "#f5f5f5", color = NA),
                      plot.margin = margin(20, 20, 20, 20)
                    )
}
```

## (iv) data manipulation

```{r}
out.col <- c("lightgreen", "tomato",
            "lightgreen", "tomato", "tomato" ,"tomato", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato" )


out.lab <- c( "us_hx1", "ds_hx1",
          "us_hx2", "hx2ds_3us", "hx3ds_4us" ,"hx4ds_5us", "ds_hx5",
          "us_hx6", "ds_hx6",
          "us_hx7", "ds_hx7",
          "us_hx8", "hx8ds_9us", "ds_hx9",
          "us_hx10", "ds_hx10",
          "us_hx11",  "ds_hx11",
          "us_hx12", "ds_hx12",
          "us_hx13", "ds_hx13",
          "us_hx14", "ds_hx14",
          "us_hx15", "ds_hx15" )

my.sites <- c( "site_1", "site_2","site_3", "site_4", "site_5" ,
              "site_6", "site_7", "site_8", "site_9","site_10", 
              "site_11" ) 

```

# --- from distribution to linear model

```{r}

# explore the data
# partition the data into 2 rows and 2 columns
par( mfrow = c( 2, 2 ) )

# names(all_data)
# check the distribution of predictor
hist( all_data$ei )
hist( log( all_data$ei ) )

# check the distribution of response
hist( all_data$bkf_A )
hist( log(all_data$bkf_A ) )

```

# --- linear models

-   Hydraulic geometry model (classical hydraulic geometry model relates channel dimensions to catchment area)

-   model output - what they means?

-   **Call:** a reminder of your model

-   **Coefficients:** estimates (and their error) for each factor level

-   **Intercept** is the mean for the first factor level

-   **Multiple R2:** variance explained by predictors (adjusted r2 also)

-   **Difference** considered significant when p \< 0.05

## ca vs ei

-   strong relationship exist (r2 is about 90%)

```{r }

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( ei ) ),
               method = "loess", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( ei ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of EI ",
        title = "Catchment area (CA) versus effective cover (EI)", 
        subtitle = paste0(
            "Strong correlation between CA and EI (r2 = ~ 90%)" ) ) +
  theme_extra( ) )


CA.model <- lm( log( ei ) ~ log( CA ) , data = all_data )
summary( CA.model )

```

## mx_D

-   Outfalls 2 had close proximity to other outfalls

-   Outfalls 6 is an industrial area

-   Outfalls 13 and 14 have maximum depth (significant change in ei) and

-   Outfall 6 is the lowest (industrial area)

```{r}

# all datasets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( mx_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( mx_D ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of mx_D ",
        title = "catchment area (CA) versus maximum depth (mx_D)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( mx_D )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( mx_D ), fill = xs_N, size = mx_D ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( mx_D ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of mx_D",
              title = "catchment area versus versus maximum depth", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( mx_D = mean( mx_D )  )

( ggplot( pool_riffle, aes( log( CA ), log ( mx_D  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of mx_D",
        title = "catchment area vs. maximum depth", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

mx_D.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( mx_D = mean( mx_D ) )

( ggplot( mx_D.summary ) +
  geom_smooth( aes( log( CA ) , log( mx_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( mx_D ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of mx_D ",
        title = "catchment area vs. maximum depth",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$mxD <- ifelse( ds_change$ds_mx_D < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_mx_D ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_mx_D, colour = mxD ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_mx_D, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ mx_D",
        title = "Δ effective cover vs. Δ maximum depth",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_mx_D = seq( 1 , length( ds_change$ds_mx_D ) )
ds_mx_D.stage = ds_change$ds_mx_D
out_L = ds_change$out_L

data <- data.frame( x.ds_mx_D, ds_mx_D.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_mx_D, y = ds_mx_D.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_mx_D, y = ds_mx_D.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ mx_D",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

## boxplot ----
#figure out how to put a scale
all_data$out_L <- factor(  all_data$out_L, out.lab )

( out_L <- ggplot( all_data, aes( out_L, log( mx_D ) ) ) +
                    geom_point(  ) +
                    geom_boxplot( fill = out.col, width = 0.7 ) +
                    labs( title = "Upstream-vs-downstream at outfalls", x = "Surveyed sections", 
                          y = "log of mx_D" )  +
                    stat_summary(aes( ymax = after_stat(y), ymin = after_stat(y) ),
                             fun = "mean",
                             geom = "pointrange",
                             # Use geom_errorbar to add line as mean
                             # color = "red",
                             position = position_dodge(width = 0.75), 
                             # Add the line to each group
                             show.legend = TRUE)  +
                    annotate(geom = "point", x = c(3, 7), y = c(2, 2), colour = c("lightgreen", "tomato"), size = 4 ) + 
                    annotate(geom = "text", x = c(3.5, 7.5), y = c(2, 2), label = c("Upstream", "Downstream"), hjust = "left") +
                    theme_extra( ) +
                    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) )

## based on sites

all_data$site <- factor(all_data$site, my.sites)

( site <- ggplot( all_data, aes( site, log( mx_D ) ) ) +
                  geom_point(  ) +
                  geom_boxplot( fill = "orange", width = 0.7 ) +
                  labs( title = "Sites based on closeness", x = "channel outfalls", 
                        y = "log of mx_D" )  +
                  stat_summary(aes( ymax = after_stat(y), ymin = after_stat(y) ),
                           fun = "mean",
                           geom = "pointrange",
                           # Use geom_errorbar to add line as mean
                           # color = "red",
                           position = position_dodge(width = 0.75), 
                           # Add the line to each group
                           show.legend = TRUE)  +
                  theme_extra( ) +
                  theme( axis.text.x = element_text( size = 12, angle = 90 ) ) )


# model summary
CA_mx_D_model <- lm( log( mx_D ) ~ log( CA ) , data = all_data )
mx_D_both <- lm( log( mx_D ) ~ log(CA) + log( ei ), data = all_data )
summary( mx_D_both )
summary( CA_mx_D_model )

ds_mx_D_model <- lm( ds_mx_D  ~ ds_ei , data = ds_change )
summary( ds_mx_D_model )

```

## avg_D

-   average depth is not significant even when ei is added to the classical model (including for step change)
-   For the step change observations, there is no relationship
-   (visualize with below and study area image above)
-   most sections indicated to have decreased for maximum depth applies to average depth, except outfall 15
-   Outfall 13 has maximum avarage depth

```{r}

# all datasets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( avg_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( avg_D ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of avg_D ",
        title = "catchment area (CA) versus average depth (avg_D)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( avg_D )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( avg_D ), fill = xs_N, size = avg_D ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( avg_D ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of avg_D",
              title = "catchment area versus versus average depth", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( avg_D = mean( avg_D )  )

( ggplot( pool_riffle, aes( log( CA ), log ( avg_D  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of avg_D",
        title = "catchment area vs. average depth", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

avg_D.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( avg_D = mean( avg_D ) )

( ggplot( avg_D.summary ) +
  geom_smooth( aes( log( CA ) , log( avg_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( avg_D ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of avg_D ",
        title = "catchment area vs. average depth",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$avg_D <- ifelse( ds_change$ds_avg_D < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_avg_D ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_avg_D, colour = avg_D ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_avg_D, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ avg_D",
        title = "Δ effective cover vs. Δ average depth",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_avg_D = seq( 1 , length( ds_change$ds_avg_D ) )
ds_avg_D.stage = ds_change$ds_avg_D
out_L = ds_change$out_L

data <- data.frame( x.ds_avg_D, ds_avg_D.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_avg_D, y = ds_avg_D.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_avg_D, y = ds_avg_D.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ avg_D",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )



# model summary
CA_avg_D_model <- lm( log( avg_D ) ~ log( CA ) , data = all_data )
avg_D_both <- lm( log( avg_D ) ~ log(CA) + log( ei ), data = all_data )
summary( avg_D_both )
summary( CA_avg_D_model )

ds_avg_D_model <- lm( ds_avg_D  ~ ds_ei , data = ds_change )
summary( ds_avg_D_model )
```

## bkf_W

-   width is not significant even when ei is added to the classical model (including for step change)
-   For the step change observations, there is no relationship
-   (visualize with below and study area image above)
-   most hard point sections had low bankfull width in the downstream section (outfalls 11, 15, and 7)
-   Farther upstream sections had lower width at the downstream section (outfalls - 1, 2 , and 3)
-   Outfall 13 has maximum width

```{r}

# all data sets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( bkf_W ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( bkf_W ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of bkf_W ",
        title = "catchment area (CA) versus bankfull width (bkf_W)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )


 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( bkf_W )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( bkf_W ), fill = xs_N, size = bkf_W ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( bkf_W ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of bkf_W",
              title = "catchment area versus versus bankfull width", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( bkf_W = mean( bkf_W )  )

( ggplot( pool_riffle, aes( log( CA ), log ( bkf_W  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of bkf_W",
        title = "catchment area vs. bankfull width", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

bkf_W.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( bkf_W = mean( bkf_W ) )

( ggplot( bkf_W.summary ) +
  geom_smooth( aes( log( CA ) , log( bkf_W ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( bkf_W ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of bkf_W ",
        title = "catchment area vs. bankfull width",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$bkf_W <- ifelse( ds_change$ds_bkf_W < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_bkf_W ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_bkf_W, colour = bkf_W ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_bkf_W, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ bkf_W",
        title = "Δ effective cover vs. Δ bankfull width",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_bkf_W = seq( 1 , length( ds_change$ds_bkf_W ) )
ds_bkf_W.stage = ds_change$ds_bkf_W
out_L = ds_change$out_L

data <- data.frame( x.ds_bkf_W, ds_bkf_W.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_bkf_W, y = ds_bkf_W.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_bkf_W, y = ds_bkf_W.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ bkf_W",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary
CA_bkf_W_model <- lm( log( bkf_W ) ~ log( CA ) , data = all_data )
bkf_W_both <- lm( log( bkf_W ) ~ log(CA) + log( ei ), data = all_data )
summary( bkf_W_both )
summary( CA_bkf_W_model )

ds_bkf_W_model <- lm( ds_bkf_W  ~ ds_ei , data = ds_change )
summary( ds_bkf_W_model )

```

## bkf_A

-   channel area is not significant even when ei is added to the classical model (including for step change)
-   For the step change observations, there is no relationship
-   (visualize with plots below and study area image above)
-   most hard point sections had low bankfull area in the downstream section (outfalls 11, 15, and 7)
-   Farther upstream had lower width at the downstream section (outfalls - 1, 2 , and 3)
-   Outfall 13 has largest bankfull area
-   The industrial area is also contracted at the downstream section of the stream (outfall 6)

```{r}

# all data sets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( bkf_A ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( bkf_A ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of bkf_A ",
        title = "catchment area (CA) versus bankfull area (bkf_A)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( bkf_A )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( bkf_A ), fill = xs_N, size = bkf_A ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( bkf_A ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of bkf_A",
              title = "catchment area versus versus bankfull area", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( bkf_A = mean( bkf_A )  )

( ggplot( pool_riffle, aes( log( CA ), log ( bkf_A  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of bkf_A",
        title = "catchment area vs. bankfull area", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

bkf_A.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( bkf_A = mean( bkf_A ) )

( ggplot( bkf_A.summary ) +
  geom_smooth( aes( log( CA ) , log( bkf_A ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( bkf_A ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of bkf_A ",
        title = "catchment area vs. bankfull area",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$bkf_A <- ifelse( ds_change$ds_bkf_A < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_bkf_A ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_bkf_A, colour = bkf_A ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_bkf_A, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ bkf_A",
        title = "Δ effective cover vs. Δ bankfull area",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_bkf_A = seq( 1 , length( ds_change$ds_bkf_A ) )
ds_bkf_A.stage = ds_change$ds_bkf_A
out_L = ds_change$out_L

data <- data.frame( x.ds_bkf_A, ds_bkf_A.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_bkf_A, y = ds_bkf_A.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_bkf_A, y = ds_bkf_A.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ bkf_A",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary
CA_bkf_A_model <- lm( log( bkf_A ) ~ log( CA ) , data = all_data )
bkf_A_both <- lm( log( bkf_A ) ~ log(CA) + log( ei ), data = all_data )
summary( bkf_A_both )
summary( CA_bkf_A_model )

ds_bkf_A_model <- lm( ds_bkf_A  ~ ds_ei , data = ds_change )
summary( ds_bkf_A_model )

```

## wd_R

-   bankfull incision is not signif. even when ei is added to the classical model (including for step change)
-   For the step change observations, there is no relationship
-   (visualize with plots below and study area image above)
-   hard point sections had low bankfull area in the downstream section (outfalls 14 and 7)
-   Farther upstream had lower width at the downstream section (outfalls - 1, 2 , and 3, 4, 5)
-   Outfalls 8 and 9 (presence of grade control points)
-   Outfall 6 has largest bankfull incision (industrial section of the stream) - why is this?

```{r}

# all data sets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( wd_R ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( wd_R ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of wd_R ",
        title = "catchment area (CA) versus bankull incision ratio (wd_R)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )
 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( wd_R )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( wd_R ), fill = xs_N, size = wd_R ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( wd_R ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of wd_R",
              title = "catchment area versus versus bankull incision ratio", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( wd_R = mean( wd_R )  )

( ggplot( pool_riffle, aes( log( CA ), log ( wd_R  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of wd_R",
        title = "catchment area vs. bankull incision ratio", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

wd_R.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( wd_R = mean( wd_R ) )

( ggplot( wd_R.summary ) +
  geom_smooth( aes( log( CA ) , log( wd_R ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( wd_R ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of wd_R ",
        title = "catchment area vs. bankull incision ratio",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$wd_R <- ifelse( ds_change$ds_wd_R < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_wd_R ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_wd_R, colour = wd_R ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_wd_R, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ wd_R",
        title = "Δ effective cover vs. Δ bankull incision ratio",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_wd_R = seq( 1 , length( ds_change$ds_wd_R ) )
ds_wd_R.stage = ds_change$ds_wd_R
out_L = ds_change$out_L

data <- data.frame( x.ds_wd_R, ds_wd_R.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_wd_R, y = ds_wd_R.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_wd_R, y = ds_wd_R.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ wd_R",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary
CA_wd_R_model <- lm( log( wd_R ) ~ log( CA ) , data = all_data )
wd_R_both <- lm( log( wd_R ) ~ log(CA) + log( ei ), data = all_data )
summary( wd_R_both )
summary( CA_wd_R_model )

ds_wd_R_model <- lm( ds_wd_R  ~ ds_ei , data = ds_change )
summary( ds_wd_R_model )
```

## cd_R

```{r}

# all data sets ------------

( ggplot( all_data ) +
    
  geom_smooth( aes( log( CA ) , log( cd_R ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( cd_R ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of cd_R ",
        title = "catchment area (CA) versus depth ratio (cd_R)", 
        subtitle = paste0(
            "not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )
 
## (ii) all_trans ---------

( ggplot( all_data ) +
          geom_smooth( aes( log( CA ), log ( cd_R )  ),
                       method = "lm", formula = 'y ~ x',
                       se = TRUE, alpha = .3, color = "grey75" ) +
          geom_point( aes( log( CA ), log ( cd_R ), fill = xs_N, size = cd_R ),
                      shape = 21, stroke = .25, alpha = 0.75 ) +
          geom_text_repel( data = all_data, 
                           aes(x = log(CA), y = log( cd_R ), label = xs_N ),
                           size = 3 ) +
          coord_cartesian(expand = TRUE, clip = "off") +
          scale_size_continuous( guide = guide_legend(
                                  override.aes = list( color = "grey10" ),
                                  title = "Size" ) ) +
          # scale_fill_manual( values = c( "#FFD5AA", "#FFBE7C", "#FF9021", "#F27900",
          #                                  "#C46200", "#964B00", "#994D1C", "#884A39",
          #                                  "#6B240C" ),
          #                      guide = guide_legend( title = "transects", 
          #                                            override.aes = list(size = 3, alpha = 0.75 ) ) ) +
          labs( x = "log of CA", 
              y = "log of cd_R",
              title = "catchment area versus versus depth ratio", 
                subtitle = paste0(
                    "transects size" ) ) +
          theme_extra( ) )

## (iii) u/s vs d/s ---------

pool_riffle <- all_data %>%
               group_by( pos, CA, ei ) %>%
               summarise( cd_R = mean( cd_R )  )

( ggplot( pool_riffle, aes( log( CA ), log ( cd_R  ),
                            group = pos )  ) +
  geom_smooth( method = "lm", formula = 'y ~ x', 
               se = TRUE, aes( color = pos ) ) +
  geom_point( aes( color = pos ), size = 2 ) +
  scale_color_manual( values = c( "#EE7600", "#00868B" ),
                     guide = guide_legend( title = "transects", 
                                           override.aes = list(size = 3, alpha = 0.75 ) ) ) +
  theme_extra( ) +
  labs( x = "log of CA",
        y = "log of cd_R",
        title = "catchment area vs. depth ratio", 
        subtitle = paste0(
            "upstream versus downstream" ) ) )


## (iv) sect of outfalls ---------

cd_R.summary <- all_data %>% 
                group_by( out_L, CA ) %>% 
                summarise( cd_R = mean( cd_R ) )

( ggplot( cd_R.summary ) +
  geom_smooth( aes( log( CA ) , log( cd_R ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75"  ) +
  geom_point( aes( log( CA ) , log( cd_R ) ), size = 2, colour = "#8A4198"  ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of cd_R ",
        title = "catchment area vs. depth ratio",
        subtitle = paste0(
            "summary based on outfalls sections" ) ) +
  theme_extra( ) )

## (v) change ----------

ds_change$cd_R <- ifelse( ds_change$ds_cd_R < 0.00, "Decrease", "Increase")

( ggplot( ds_change ) +
  geom_smooth( aes( log( ds_ei ), ds_cd_R ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( ds_ei ), ds_cd_R, colour = cd_R ),  size = 2  ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_cd_R, label = out_L ),
                         hjust = 0, vjust = 1,
                         box.padding = unit( 0.95, "lines" ),
                         point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of Δ ei", 
        # y-axis cannot be log transformed because of negative values
        y = "Δ cd_R",
        title = "Δ effective cover vs. Δ depth ratio",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_cd_R = seq( 1 , length( ds_change$ds_cd_R ) )
ds_cd_R.stage = ds_change$ds_cd_R
out_L = ds_change$out_L

data <- data.frame( x.ds_cd_R, ds_cd_R.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_cd_R, y = ds_cd_R.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_cd_R, y = ds_cd_R.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ cd_R",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary
CA_cd_R_model <- lm( log( cd_R ) ~ log( CA ) , data = all_data )
cd_R_both <- lm( log( cd_R ) ~ log(CA) + log( ei ), data = all_data )
summary( cd_R_both )
summary( CA_cd_R_model )

ds_cd_R_model <- lm( ds_cd_R  ~ ds_ei , data = ds_change )
summary( ds_cd_R_model )
```

## bkf_R and bkf_L

```{r}

( ggplot( all_data, aes( log( bkf_R ) , log( bkf_L ) ) ) +
  geom_smooth( method = "lm", formula = 'y ~ x' ) +
  geom_point( ) +
  theme_clean( ) +
  labs( x = "log of bkf_R", 
        y = "log of bkf_L",
        title = "bankfull right vs. bankfull left", 
        tag = "" ) +
        theme_extra( ) )

# a bit of data manipulation here
x.bkf_L = seq( 1 , length( all_data$bkf_L ) )
x.bkf_R = seq( 1 , length( all_data$bkf_R ) )
x.bkf_R = seq( 1 , length( all_data$bkf_R ) )

# a bit of data manipulation here
bkf_L.stage = all_data$bkf_L
bkf_R.stage = all_data$bkf_R
data <- data.frame( x.bkf_L, x.bkf_R, bkf_L.stage, bkf_R.stage )
(ggplot( data ) + 
        geom_point( aes( x = x.bkf_L, y = bkf_L.stage ), colour = "red" ) + 
        geom_point( aes( x = x.bkf_R, y = bkf_R.stage ), colour ="blue" ) + 
        scale_color_manual( values = c( "black", "red" ) )  +
        labs( x = "downstream length (not to scale)", 
              y = "bkf_L and bkf_R",
              title = "mean of bankfull right vs. mean of bankfull left", 
              tag = "" ) +
        theme_extra( ) )

```

## lwd

```{r}
# all data sets ------------
( ggplot( in_channel_data ) +
  geom_smooth( aes( log( CA ) , log( lwd_N ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( lwd_N ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of n-LWD ",
        title = "Catchment area (CA) vs norm. woody debris (lwd_N)", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

# classical model
CA_lwd_N_model <- lm( lwd_N ~ log( CA ), data = in_channel_data )
lwd_N_both <- lm( lwd_N ~ log(CA) + log( ei ), data = in_channel_data )
summary( CA_lwd_N_model )
summary( lwd_N_both )


# reduced data set --------------

lwd_N.summary <- in_channel_data %>% 
                 group_by( out_L, CA ) %>% 
                 summarise(lwd_N = mean( lwd_N ) )

( ggplot( lwd_N.summary , aes(  log( CA ) , lwd_N ) ) +
  geom_smooth( aes(  log( CA ) , lwd_N ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log( CA ) , lwd_N ), size = 2, colour = "#8A4198" ) +
  labs( x = "log of CA", 
        y = "log of n-LWD.",
        title = "Catchment area (CA) vs. norm. woody debris (LWD)", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( )  )


# step change in ----------

ds_change$lwd_D <- ifelse( ds_change$ds_lwd_D < 0.00, "Decrease", "Increase" )

( ggplot( ds_change , aes(  log (ds_ei) , ds_lwd_D ) ) +
  geom_smooth( aes(  log (ds_ei) , ds_lwd_D ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log (ds_ei) , ds_lwd_D, colour = lwd_D ),  size = 2 ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_wd_R, label = out_L ),
                        hjust = 0, vjust = 1,
                        box.padding = unit(0.95, "lines"),
                        point.padding = unit(0.95, "lines") )  +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of ds EI", 
        y = "ds n-LWD",
        title = "Δ effective cover vs. Δ large woody debris",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )

## (vi) view sake
x.ds_lwd_D = seq( 1 , length( ds_change$ds_lwd_D ) )
ds_lwd_D.stage = ds_change$ds_lwd_D
out_L = ds_change$out_L

data <- data.frame( x.ds_lwd_D, ds_lwd_D.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_lwd_D, y = ds_lwd_D.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_lwd_D, y = ds_lwd_D.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ lwd_D",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary using change in effective catchment area
EI_ds_lwd_D_model <- lm( ds_lwd_D  ~ ds_ei , data = ds_change )
summary( EI_ds_lwd_D_model )
ds_lwd_D_model <- lm( ds_lwd_D  ~ ds_ei , data = ds_change )
summary( ds_lwd_D_model )

# http://www.sthda.com/english/wiki/ggplot2-texts-add-text-annotations-to-a-graph-in-r-software

```

## bar/benches

```{r}

# all data ---------------
( ggplot( in_channel_data ) +
  geom_smooth( aes( log( CA ) ,  log( Bars ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( Bars ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "channel bar frequency ",
        title = "Catchment area (CA) vs bar frequency", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

# classical model
CA_bar_model <- lm( Bars ~ log( CA ), data = in_channel_data )
bar_both <- lm( Bars ~ log(CA) + log( ei ), data = in_channel_data )
summary( CA_bar_model )
summary( bar_both )


# reduced data set ------------
bar.summary <- in_channel_data %>% 
                 group_by( out_L, CA ) %>% 
                 summarise(bar = sum( Bars ) )

( ggplot( bar.summary , aes(  log( CA ) , bar ) ) +
  geom_smooth( aes(  log( CA ) , bar ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log( CA ) , bar ), size = 2, colour = "#8A4198" ) +
  labs( x = "log of CA", 
        y = "channel bar frequency.",
        title = "Catchment area (CA) vs. bar frequency", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( )  )


# step change ----------------

ds_change$bar <- ifelse( ds_change$ds_bar < 0.00, "Decrease", "Increase" )

( ggplot( ds_change , aes(  log (ds_ei) , ds_bar ) ) +
  geom_smooth( aes(  log (ds_ei) , ds_bar ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log (ds_ei) , ds_bar, colour = bar ),  size = 2 ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_bar, label = out_L ),
                        hjust = 0, vjust = 1,
                        box.padding = unit(0.95, "lines"),
                        point.padding = unit(0.95, "lines") )  +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of ds EI", 
        y = "Δ bar drequency",
        title = "Δ effective cover vs. Δ bar frequency",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )


## (vi) view sake
x.ds_bar = seq( 1 , length( ds_change$ds_bar ) )
ds_bar.stage = ds_change$ds_bar
out_L = ds_change$out_L

data <- data.frame( x.ds_bar, ds_bar.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.ds_bar, y = ds_bar.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.ds_bar, y = ds_bar.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ bar_D",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )


# model summary using change in effective catchment area
EI_ds_bar_model <- lm( ds_bar  ~ ds_ei , data = ds_change )
summary( EI_ds_bar_model )
```

## pool

```{r}

# all data ---------------

( ggplot( in_channel_data ) +
  geom_smooth( aes( log( CA ) ,  log( pool_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( pool_D ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of pool spacing",
        title = "catchment area (CA) vs pool spacing", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

# classical model
CA_pool_D_model <- lm( log(pool_D) ~ log( CA ), data = in_channel_data )
pool_D_both <- lm( Bars ~ log(CA) + log( ei ), data = in_channel_data )
summary( CA_pool_D_model )
summary( pool_D_both )


# reduced data set ------------

pool.summary <- in_channel_data %>% 
                 select( pool_D, CA, out_L ) %>%
                 group_by( out_L, CA ) %>% 
                 na.omit() %>% 
                 summarise(pool_D = mean( pool_D ) )

( ggplot( pool.summary , aes(  log( CA ) , pool_D ) ) +
  geom_smooth( aes(  log( CA ) , pool_D ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log( CA ) , pool_D ), size = 2, colour = "#8A4198" ) +
  labs( x = "log of CA", 
        y = "log of pool spacing.",
        title = "catchment area (CA) vs. pool spacing", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( )  )


# step change ----------------

ds_change$poolD <- ifelse( ds_change$ds_poolD < 0.00, "Decrease", "Increase" )

( ggplot( ds_change , aes(  log (ds_ei) , ds_poolD ) ) +
  geom_smooth( aes(  log (ds_ei) , ds_poolD ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log (ds_ei) , ds_poolD, colour = poolD ),  size = 2 ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_poolD, label = out_L ),
                        hjust = 0, vjust = 1,
                        box.padding = unit(0.95, "lines"),
                        point.padding = unit(0.95, "lines") )  +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of ds EI", 
        y = "Δ pool spacing",
        title = "Δ effective cover vs. Δ pool spacing",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )

## (vi) view sake
x.poolD = seq( 1 , length( ds_change$poolD ) )
poolD.stage = ds_change$poolD
out_L = ds_change$out_L

data <- data.frame( x.poolD, poolD.stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x.poolD, y = poolD.stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x.poolD, y = poolD.stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ pool",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary using change in effective catchment area
EI_ds_poolD_model <- lm( ds_poolD  ~ ds_ei , data = ds_change )
summary( EI_ds_poolD_model )

```

## Riffle

```{r}

# all data ---------------

( ggplot( in_channel_data ) +
  geom_smooth( aes( log( CA ) ,  log( riffle_D ) ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes( log( CA ) , log( riffle_D ) ), size = 2, colour = "#8A4198" ) +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of CA", 
        y = "log of riffle spacing",
        title = "catchment area (CA) vs riffle spacing", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( ) )

# classical model
CA_riffle_D_model <- lm( log(riffle_D) ~ log( CA ), data = in_channel_data )
riffle_D_both <- lm( Bars ~ log(CA) + log( ei ), data = in_channel_data )
summary( CA_riffle_D_model )
summary( riffle_D_both )


# reduced data set ------------

riffle.summary <- in_channel_data %>% 
                 select( riffle_D, CA, out_L ) %>%
                 group_by( out_L, CA ) %>% 
                 na.omit() %>% 
                 summarise(riffle_D = mean( riffle_D ) )

( ggplot( riffle.summary , aes(  log( CA ) , riffle_D ) ) +
  geom_smooth( aes(  log( CA ) , riffle_D ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log( CA ) , riffle_D ), size = 2, colour = "#8A4198" ) +
  labs( x = "log of CA", 
        y = "log of riffle spacing.",
        title = "catchment area (CA) vs. riffle spacing", 
        subtitle = paste0(
            "Not significant when EI is added to the classical model" ) ) +
  theme_extra( )  )


# step change ----------------

options(ggrepel.max.overlaps = Inf)

ds_change$riffleD <- ifelse( ds_change$ds_riffleD < 0.00, "Decrease", "Increase" )

( ggplot( ds_change , aes(  log (ds_ei) , ds_riffleD ) ) +
  geom_smooth( aes(  log (ds_ei) , ds_riffleD ),
               method = "lm", formula = 'y ~ x', 
               se = TRUE, alpha = .3, color = "grey75" ) +
  geom_point( aes(  log (ds_ei) , ds_riffleD, colour = riffleD ),  size = 2 ) +
  geom_text_repel( data = ds_change,
                   aes( log( ds_ei ), ds_riffleD, label = out_L ),
                        hjust = 0, vjust = 1,
                        box.padding = unit(0.95, "lines"),
                        point.padding = unit(0.95, "lines") )  +
  coord_cartesian(expand = TRUE, clip = "off") +
  labs( x = "log of ds EI", 
        y = "Δ riffle spacing",
        title = "Δ effective cover vs. Δ riffle spacing",
        subtitle = paste0(
            "Dowstream step change (no relationship and no sig. df.)" ) ) +
  scale_color_manual( values = c( "black", "red" ), 
                      guide = guide_legend( title = "Δ at outfalls", 
                                            override.aes = list(size = 3, alpha = 1) )  )  +
  theme_extra( ) + theme( legend.position = "bottom" )  )

## (vi) view sake
x. = seq( 1 , length( ds_change$riffleD ) )
.stage = ds_change$
out_L = ds_change$out_L

data <- data.frame( x., .stage, out_L )

(ggplot( data ) + 
        geom_point( aes( x = x., y = .stage ), size = 2, colour = "#8A4198" ) + 
        geom_text_repel( data = data,
                         aes( x = x., y = .stage, label = out_L ),
                               hjust = 0, vjust = 1,
                               box.padding = unit( 0.95, "lines" ),
                               point.padding = unit( 0.9, "lines" ), color = "grey30" ) +
        labs( x = "downstream length (not to scale)", 
              y = "Δ pool spacing",
              title = "Just the observation of magnitude",
        subtitle = paste0(
            "What are the sizes?" ) ) +
        theme_extra( ) )

# model summary using change in effective catchment area
EI_ds_riffleD_model <- lm( ds_riffleD  ~ ds_ei , data = ds_change )
summary( EI_ds_riffleD_model )

## https://ggrepel.slowkow.com/articles/examples.html#:~:text=Use%20options(ggrepel.,overridden%20by%20providing%20the%20max.
```

# --- boxplots

## u/s and d/s

```{r}

all_data$pos <- as.factor( all_data$pos )

# str(all_data)

( pos <-ggplot( all_data, aes( pos, log(bkf_A), fill = pos, group = pos ) ) +
      geom_point( size = 2 ) +
      geom_boxplot( aes(fill = pos), width = 0.5 ) +
      labs( title = "downstream vs. upstream of outfalls", x = "", y = "log of bkf_A" ) +
      coord_cartesian(expand = TRUE, clip = "off") +
      scale_fill_manual( values = c( "#EE7600", "#00868B" ),
                   guide = guide_legend( title = "sections of outfalls", 
                                         override.aes = list(size = 3, alpha = 0.75 ) ) ) +
      stat_summary(aes(ymax = after_stat(y), ymin = after_stat(y)),
               fun = "mean",
               geom = "pointrange",
               # Use geom_errorbar to add line as mean
               # color = "red",
               position = position_dodge(width = 0.75), 
               # Add the line to each group
               show.legend = FALSE) +
      theme_extra ( ) )

```

## transects

```{r}

out.col <- c("lightgreen", "tomato",
            "lightgreen", "tomato", "tomato" ,"tomato", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato",
            "lightgreen", "tomato" )


out.lab <- c( "us_hx1", "ds_hx1",
          "us_hx2", "hx2ds_3us", "hx3ds_4us" ,"hx4ds_5us", "ds_hx5",
          "us_hx6", "ds_hx6",
          "us_hx7", "ds_hx7",
          "us_hx8", "hx8ds_9us", "ds_hx9",
          "us_hx10", "ds_hx10",
          "us_hx11",  "ds_hx11",
          "us_hx12", "ds_hx12",
          "us_hx13", "ds_hx13",
          "us_hx14", "ds_hx14",
          "us_hx15", "ds_hx15" )

#figure out how to put a scale
all_data$out_L <- factor(  all_data$out_L, out.lab )

( out_L <- ggplot( all_data, aes( out_L, log( bkf_A ) ) ) +
                    geom_point(  ) +
                    geom_boxplot( fill = out.col, width = 0.7 ) +
                    labs( title = "Upstream-vs-downstream at outfalls", x = "Surveyed sections", 
                          y = "log of bkf_A" )  +
                    stat_summary(aes( ymax = after_stat(y), ymin = after_stat(y) ),
                             fun = "mean",
                             geom = "pointrange",
                             # Use geom_errorbar to add line as mean
                             # color = "red",
                             position = position_dodge(width = 0.75), 
                             # Add the line to each group
                             show.legend = TRUE)  +
                    annotate(geom = "point", x = c(3, 7), y = c(3, 3), colour = c("lightgreen", "tomato"), size = 4 ) + 
                    annotate(geom = "text", x = c(3.5, 7.5), y = c(3, 3), label = c("Upstream", "Downstream"), hjust = "left") +
                    theme_extra( ) +
                    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) )

```

## sites

```{r}

my.sites <- c( "site_1", "site_2","site_3", "site_4", "site_5" ,
              "site_6", "site_7", "site_8", "site_9","site_10", 
              "site_11" ) 
all_data$site <- factor(all_data$site, my.sites)

( site <- ggplot( all_data, aes( site, log( bkf_A ) ) ) +
                  geom_point(  ) +
                  geom_boxplot( fill = "orange", width = 0.7 ) +
                  labs( title = "Sites based on closeness", x = "channel outfalls", 
                        y = "log of bkf_A" )  +
                  stat_summary(aes( ymax = after_stat(y), ymin = after_stat(y) ),
                           fun = "mean",
                           geom = "pointrange",
                           # Use geom_errorbar to add line as mean
                           # color = "red",
                           position = position_dodge(width = 0.75), 
                           # Add the line to each group
                           show.legend = TRUE)  +
                  theme_extra( ) +
                  theme( axis.text.x = element_text( size = 12, angle = 90 ) ) )

```

# HARDPOINTS

