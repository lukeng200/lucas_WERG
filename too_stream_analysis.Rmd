---
title: "Statistical analysis"
author: "Lukman Adeboye Soboyejo"
date: "2023-10-24"
output: word_document
always_allow_html: true
---


```{r global_options, include = FALSE}

knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(echo= FALSE)

```

## Retrieving data from github (saved privately) and read channel data into R
```{r}

# remove all object in r environment
# rm(list=ls(all=TRUE))

# get the URL for the raw version by clicking on the Raw button displayed above the data (token at the end)
too_data = read.csv("https://raw.githubusercontent.com/lukeng200/lucas_WERG/main/too_stream_survey.csv?token=GHSAT0AAAAAACJOZ422RQLVKL24AVSJATHIZKIZ55Q",
                  header = T,sep = ",")
too_data

# view the data in a nice format with pander or kable
# knitr::kable(too_data)
pander::pander( head( too_data ) )

```


## theme for visualisation

```{r}

# set up theme
theme.clean <- function(){
  theme_bw()+
  theme(axis.text.x = element_text(size = 12, angle = 45, vjust = 1, hjust = 1),
        axis.text.y = element_text(size = 12),
        axis.title.x = element_text(size = 14, face = "plain"),             
        axis.title.y = element_text(size = 14, face = "plain"),             
        panel.grid.major.x = element_blank(),                                          
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.major.y = element_blank(),  
        plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), units = , "cm"),
        plot.title = element_text(size = 20, vjust = 1, hjust = 0.5),
        legend.text = element_text(size = 12, face = "italic"),          
        legend.position = "right")
}

```

# FROM DISTRIBUTIONS TO LINEAR MODELS

```{r}

# explore the data
par(mfrow=c(2,2))
hist( df$ei_2022 )
hist( log(df$ei_2022 ) )

hist( df$CA )
hist( log(df$CA ) )

hist( df$bkf_A )
hist( log( df$bkf_A ) )

```

## CLASSICAL MODEL

-   Classical hydraulic geometry model
-   Relates channel dimensions to catchment area

```{r }

# increasing catchment area
basic.ca_lm <- lm( log( bkf_A ) ~ log( CA ), data = df )
summary( basic.ca_lm )

# increasing effective area
basic.ei_lm <- lm( log( bkf_A ) ~ log( ei_2022 ), data = df )
summary( basic.ei_lm  )

```

-   We are trying to look at the effect of urbanisation on downstream channel morphology
-   The effect of stormwater or runoff input varies as catchment area increases
-   More likely that the effect is significant at the d/s section than u/s section
-   i.e., larger channel dimensions in the d/s than the u/s

## ADDING MORE PREDICTORS

```{r}

# considering effective area at a point
mult.pred1 <- lm( log( bkf_A ) ~ log(CA) + log( ei_2022 ), data = df )
summary( mult.pred1 )

# considering effective area and outfall points
mult.pred2 <- lm( log( bkf_A ) ~ log( ei_2022 ) + pos, data = df )
summary( mult.pred2 )

```

-   Model outfall

-   Call: a reminder of your model

-   Coefficients: estimates (and their error) for each factor level

-   Here, (intercept) is the mean for the first factor level

-   Multiple R2: variance explained by predictors (adjusted r2 also)

-   Difference considered significant when p \< 0.05

-   making box plot to examine the data

## BOXPLOTS FOR LEVELS

```{r}

library(ggplot2)
# factoring out the influence based on u/s and d/s differences
df$fct_pos <- as.factor(df$pos)
fct_pos <- ggplot(df, aes(fct_pos, log(bkf_A) ) ) +
    geom_point( ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    theme.clean( ) +  
    theme (axis.text.x = element_text(size = 12, angle = 0 ) ) +
    labs( x = "u/s and d/s position", y = "log(bkf_A)" )
# fct_pos

# factoring out based on transects sections
df$fct_out_L <- factor(df$out_L, 
                   c( "us_hx1", "ds_hx1",
                      "us_hx2", "hx2ds_3us", "hx3ds_4us" ,"hx4ds_5us", "ds_hx5",
                      "us_hx6", "ds_hx6",
                      "us_hx7", "ds_hx7",
                      "us_hx8", "hx8ds_9us", "ds_hx9",
                      "us_hx10", "ds_hx10",
                      "us_hx11",  "ds_hx11",
                      "us_hx12", "ds_hx12",
                      "us_hx13", "ds_hx13",
                      "us_hx14", "ds_hx14",
                      "us_hx15", "ds_hx15" ) )
fct_out_L <- ggplot( df, aes( fct_out_L, log( bkf_A ) ) ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    geom_point( ) +
    stat_summary(
    fun.y = median,
    geom = 'line',
    aes( group = -1 ),
    position = position_dodge(width = 0.9) ) +
    theme.clean() +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) +
    labs( title = "upstream and donwstream change", x = "transects_locations", y = "log(bkf_A)" )
# fct_out_L


# factoring out based on sites
df$fct_site <- factor(df$site, 
                   c( "site_1", "site_2","site_3", "site_4", "site_5" ,
                      "site_6", "site_7", "site_8", "site_9","site_10", 
                      "site_11" ) )
fct_site <- ggplot( df, aes( fct_site, log( bkf_A ) ) ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    geom_point( ) +
    stat_summary(
    fun.y = median,
    geom = 'line',
    aes( group = -1 ),
    position = position_dodge(width = 0.9) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) +
    labs( x = "sites", y = "log(bkf_A)" )
# fct_site

library( plotly )
ggplotly(fct_pos)
ggplotly(fct_site)
ggplotly(fct_out_L)

```

-   bkf_A looks pretty similar across sites, at u/s vs d/s section, and most transects
-   You can check for bankfull width and depth too??
-   Although, there is a trend as we move downstream of the catchment area and effective area
-   Overlaps (see the figures)

```{r}

# - looking at the boxplot, larger channel capcity at larger CA
# - is this actually true - run a linear model to check this
fct_pos.lm <- lm( log( bkf_A ) ~ fct_pos, data = df )
summary( fct_pos.lm )

fct_site.lm <- lm( log( bkf_A ) ~ fct_site, data = df )
summary( fct_site.lm )

fct_out_L.lm <- lm( log( bkf_A ) ~ fct_out_L, data = df )
summary( fct_out_L.lm )

```

# BOXPLOT WITH X AND Y CONTINOUS PREDICTORS

```{r}

scaleFUN <- function(x) sprintf("%.2f", as.numeric(x))

# factoring out based on sites
df$fct_ei <- factor( log( df$ei_2022 ) )
fct_ei <- ggplot( df, aes( fct_ei, log( bkf_A ) ) ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    geom_point ( ) +
    stat_summary(
    fun.y = median,
    geom = 'line',
    aes( group = -1 ),
    position = position_dodge(width = 0.9) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) +
    labs( x = "log(ei_2022)", y = "log(bkf_A)" ) +
    scale_y_continuous( labels = scales::number_format(accuracy = 0.01,
                                 decimal.mark = ',')) +
    scale_x_discrete( labels = scaleFUN )
  
# fct_ei


df$fct_CA <- factor(log ( df$CA ) )
fct_CA <- ggplot( df, aes( fct_CA, log( bkf_A ) ) ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    geom_point ( ) +
    stat_summary(
    fun.y = median,
    geom = 'line',
    aes( group = -1 ),
    position = position_dodge(width = 0.9) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) +
    labs( x = "log(CA)", y = "log(bkf_A)" ) +
    scale_y_continuous( labels = scales::number_format(accuracy = 0.01,
                                 decimal.mark = ',')) +
    scale_x_discrete( labels = scaleFUN )

ggplotly(fct_ei)
ggplotly(fct_CA)

```

-   You can check for other response too??

# LOOKING AT PLOTS PRIOR TO LINEAR MIXED EFFECT MODEL

-   each site of measurement have different categories within them, i.e., pool and riffle

```{r}

us_ds <- ggplot( df, aes( x = log(ei_2022), y = log( bkf_A ) ) ) +
    geom_point( aes( colour = pos ) ) +
    labs( x = "log(ei_2022)", y = "log(bkf_A)" ) +
    geom_smooth( method = "lm", formula = 'y ~ x', se = FALSE, 
                 aes( fill = pos, colour = pos ) ) +    
    scale_colour_manual( values = c( "#FFC125", "#36648B", "#00FF00" ) ) +
    scale_fill_manual( values = c( "#FFC125", "#36648B", "#00FF00" ) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ),
           legend.position='bottom' )
us_ds

pool_riffle <- ggplot( df, aes( x = log(ei_2022), y = log( bkf_A ) ) ) +
    geom_point( aes( colour = xs_N ) ) +
    labs( x = "log(ei_2022)", y = "log(bkf_A)" ) +
    geom_smooth( method = "lm", formula = 'y ~ x', se = FALSE, 
                 aes( fill = xs_N, colour = xs_N ) ) +    
    scale_colour_manual( values = c( "#FFC125", "#36648B" ) ) +
    scale_fill_manual( values = c( "#FFC125", "#36648B" ) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ),
           legend.position='bottom' )
pool_riffle

pool_riffle_xs <- ggplot( df, aes( x = log(ei_2022), y = log( bkf_A ) ) ) +
    geom_point( aes( colour = xs_CN ) ) +
    labs( x = "log(ei_2022)", y = "log(bkf_A)" ) +
    geom_smooth( method = "lm", formula = 'y ~ x', se = FALSE, 
                 aes( fill = xs_CN, colour = xs_CN ) ) +    
    scale_colour_manual( values = c( "red", "red", "red", "yellow", "yellow", 
                                     "#DBE9AA","#DBE9AA", "green", "green" ) ) +
    scale_fill_manual( values = c( "red", "red", "red", "yellow", "yellow",
                                     "#DBE9AA","#DBE9AA", "green", "green"  ) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ),
           legend.position='bottom' )
pool_riffle_xs

# ggplotly( fct_ei2 )

```

## run multiple view

```{r}
( split_plot <- ggplot( df, aes( x = log(ei_2022), y = log( bkf_A ) ) ) + 
  geom_point() + 
  facet_wrap( ~ xs_CN ) + 
  xlab( "log(ei_2022)" ) + 
  theme.clean( ) + 
  ylab( "log( bkf_A )" ) )


ggplot( df, aes( x = log(CA ), y = log( ei_2022 ) ) ) + 
  geom_point()


scaleFUN <- function(x) sprintf("%.2f", as.numeric(x))

# factoring out based on sites
df$fct_ei <- factor( log( df$ei_2022 ) )
fct_ei <- ggplot( df, aes( fct_ei, log( bkf_A ) ) ) +
    geom_boxplot( fill = "#CD3333", alpha = 0.8, colour = "#8B2323",
                  position = position_dodge( width = 0.9 ) ) +
    geom_point ( ) +
    stat_summary(
    fun.y = median,
    geom = 'line',
    aes( group = -1 ),
    position = position_dodge(width = 0.9) ) +
    theme.clean( ) +  
    theme( axis.text.x = element_text( size = 12, angle = 90 ) ) +
    labs( x = "log(ei_2022)", y = "log(bkf_A)" ) +
    scale_y_continuous( labels = scales::number_format(accuracy = 0.01,
                                 decimal.mark = ',')) +
    scale_x_discrete( labels = scaleFUN )

# ggplot( df, aes(x = log( ei_2022 ), y = log( riffle_D ) )  ) +
#   
#   # geom_point( data = filter( df, xs_N == "pool"  ),
#   #             colour = "#B2DF8A", fill = "#B2DF8A", size = 3 ) +
#   geom_point( data = filter( df, xs_N == "riffle" ),
#               colour = "#FDBF6F", fill = "#FDBF6F", size = 3 ) +
#   # geom_smooth( data = filter( df, xs_N == "pool" ),
#   #              method = "lm", se = FALSE, formula = 'y ~ x', fill = "#B2DF8A",
#   #              aes(colour = " "), size = 1.5 ) +
#   geom_smooth( data = filter( df, xs_N == "riffle" ),
#                method = "lm", se = FALSE, formula = 'y ~ x', fill = "#FDBF6F",
#                aes(colour = ""), size = 1.5 ) +
#   theme.clean( ) +  theme(legend.position = "bottom") + labs( title = "Riffle spacing" , x = " log( ei_2022 )", 
#         y  = "log( riffle_D )", subtitle = "" ) 
# 
# 
# ggplot( df, aes(x = log( ei_2022 ), y = log( lwd_N ) )  ) +
#   labs( title = "large woody debris count" , x = "log(effective area)", 
#         y  = "Normalised LWD", subtitle = "" ) +
#   theme.clean() +
#   geom_point(  ) +
#   geom_smooth( method = "lm", se = FALSE, formula = 'y ~ x', 
#                 size = 1.5 )

```


